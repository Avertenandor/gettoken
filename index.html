<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Печать монет — Создание токена</title>
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    .connect-options { margin: 20px 0; padding: 12px; border: 1px solid #333; border-radius: 6px; background: #161a20; }
    .connect-options ol { margin: 0; padding-left: 18px; }
    .connect-options li { margin-bottom: 18px; }
    .connect-options button { margin-top: 8px; }
    .connect-options .hint { font-size: 13px; opacity: 0.7; margin-top: 4px; }
    .connect-options textarea, .connect-options input { margin-top: 8px; }
  </style>
  <link rel="icon" type="image/png" sizes="16x16" href="./favicons/favicon-16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./favicons/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./favicons/favicon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./favicons/favicon-512.png" />
  <link rel="icon" type="image/svg+xml" href="./favicons/favicon.svg" />
  <link rel="apple-touch-icon" sizes="180x180" href="./favicons/favicon-192.png" />
  <link rel="manifest" href="./site.webmanifest" />
  <meta name="theme-color" content="#2563eb" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://binaries.soliditylang.org; worker-src 'self' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://api.etherscan.io https://api.bscscan.com https://api-testnet.bscscan.com https://bsc-dataseed.binance.org https://data-seed-prebsc-1-s1.binance.org:8545 https://rpc.ankr.com https://rpc.sepolia.org https://binaries.soliditylang.org; font-src 'self'; form-action 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; upgrade-insecure-requests"> 
  <!-- Ethers.js (UMD) для работы с кошельком -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js" integrity="sha384-3R5I9P2Y5xR0lU1YQ7i1eX0t6fjJm6C6LkQtcVfMfm8p4A4J6+1mAvGbyV6H8d4Y" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <h1>Печать монет <span id="net-status" class="status-badge sb-disconnected">Не подключён</span></h1>
    <nav>
  <button data-view="connect">Подключить кошелёк</button>
  <button id="btn-disconnect" type="button">Отключить</button>
      <button data-view="deploy">Создать</button>
      <button data-view="manage">Токен</button>
  <button data-view="logs">Логи</button>
  <button data-view="batch">Batch</button>
      <button data-view="settings">Настройки</button>
    </nav>
  </header>
  <main>
    <section id="view-connect" class="view active">
      <h2>Подключить кошелёк</h2>
      <div class="connect-options">
        <h3>Варианты подключения:</h3>
        <ol>
          <li><b>Расширение браузера (MetaMask, OKX, TrustWallet)</b><br>
            <button id="btn-connect" title="Подключить через расширение">Подключить через расширение</button>
            <span id="wallet-address"></span>
            <span id="network"></span>
            <div class="hint">Рекомендуется для большинства пользователей. Безопасно, не требует передачи секретов.</div>
          </li>
          <li id="risk-modes-block" style="display:none;"><details><summary><b>Сид / Приватный ключ (НЕ РЕКОМЕНДУЕТСЯ)</b></summary>
            <div style="margin-top:8px;">
              <textarea id="alt-mnemonic" placeholder="Сид-фраза 12/24 слов" style="width:100%;min-height:60px;" aria-label="Сид фраза"></textarea>
              <button type="button" id="alt-connect-mnemonic">Подключить по сид-фразе</button>
              <div class="hint">Только временная сид-фраза. Очищается после подключения.</div>
              <hr style="margin:12px 0;opacity:0.3;">
              <input id="alt-private-key" placeholder="Приватный ключ 0x..." style="width:100%;" aria-label="Приватный ключ" type="password" />
              <button type="button" id="toggle-pk-visibility" style="font-size:11px;">Показать</button>
              <button type="button" id="alt-connect-pk">Подключить по приватному ключу</button>
              <div class="hint">Формат: 0x + 64 hex. Используйте временный ключ.</div>
            </div>
          </details></li>
          <li><b>Read-only</b><br>
            <button type="button" id="read-only-btn">Только просмотр (без подключения)</button>
            <div class="hint">Можно просматривать токен и баланс без подключения кошелька.</div>
          </li>
        </ol>
      </div>
      <div id="connect-status" class="muted" style="margin-top:8px;" role="status" aria-live="polite"></div>
    </section>
    <section id="view-deploy" class="view">
      <h2>Создание токена</h2>
      <form id="token-form" class="section">
        <div class="row">
          <input id="token-name" placeholder="Название" />
          <input id="token-symbol" placeholder="Символ" />
          <input id="token-decimals" type="number" min="0" max="18" value="18" placeholder="Decimals" />
          <input id="token-supply" type="number" min="1" value="1000000" placeholder="Начальный выпуск" />
        </div>
  <button type="submit">Создать токен</button>
  <!-- verify здесь отсутствует -->
      </form>
      <div id="deploy-status" class="muted" style="margin-top:8px;" role="status" aria-live="polite"></div>
    </section>
    <section id="view-manage" class="view">
      <h2>Токен</h2>
      <div class="section" id="token-panel" aria-live="polite">
  <div><strong>Адрес:</strong> <span id="token-address" class="mono"></span> <button id="copy-address-btn" type="button" disabled>Copy</button> <button id="watch-asset-btn" type="button" disabled>Add to Wallet</button> <a id="bscan-link" href="#" target="_blank" rel="noopener" class="hidden">Explorer</a> <button id="download-abi-btn" type="button" disabled>Download ABI</button> <button id="download-bytecode-btn" type="button" disabled>Download Bytecode</button></div>
        <div id="deployed-info" class="hidden" style="margin-top:6px;">
          <span id="token-balance" class="mono"></span>
          <button id="refresh-balance" type="button">Обновить баланс</button>
        </div>
        <div id="token-actions" class="row" style="margin-top:10px;">
          <input id="transfer-to" placeholder="Адрес получателя" size="44" />
          <input id="transfer-amount" type="number" min="0" step="0.0001" placeholder="Количество" style="width:110px;" />
          <button id="btn-transfer" type="button" disabled>Transfer</button>
          <input id="approve-spender" placeholder="Spender" size="30" />
          <input id="approve-amount" type="number" min="0" step="0.0001" placeholder="Allowance" style="width:110px;" />
          <button id="btn-approve" type="button" disabled>Approve</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="btn-save-passport" type="button" disabled>Сохранить паспорт</button>
          <input id="import-passport-file" type="file" accept="application/json" style="display:none;" />
          <button id="btn-import-passport" type="button">Импорт паспорта</button>
          <button id="btn-save-project" type="button" disabled>Сохранить проект</button>
          <button id="btn-list-projects" type="button">Список проектов</button>
          <button id="btn-load-project" type="button">Загрузить (ввести адрес)</button>
          <button id="verify-btn-manage" type="button" disabled>Верифицировать</button>
          <button id="verify-cancel-btn" type="button" disabled>Отмена</button>
          <button id="download-abi" type="button" disabled>ABI</button>
          <button id="download-bytecode" type="button" disabled>Bytecode</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="allowance-spender" placeholder="Spender для allowance" size="40" />
          <button id="check-allowance" type="button" disabled>Allowance</button>
          <span id="allowance-value" class="mono" style="font-size:12px;"></span>
        </div>
        <div id="verify-status" class="muted" style="margin-top:6px;"></div>
        <div id="verify-progress-container" class="hidden" style="margin-top:4px;">
          <div id="verify-progress-bar" style="height:6px;background:#1f2937;border-radius:3px;overflow:hidden;">
            <div id="verify-progress-inner" style="height:100%;width:0;background:#2563eb;transition:width .3s;"></div>
          </div>
          <small id="verify-progress-text" class="muted"></small>
        </div>
        <div id="projects-list" class="muted" style="margin-top:10px;"></div>
      </div>
    </section>
    <section id="view-logs" class="view">
      <h2>Логи</h2>
      <div class="row" style="gap:8px;align-items:center;margin-bottom:8px;">
        <label>Фильтр:
          <select id="log-filter">
            <option value="all">Все</option>
            <option value="info">Info</option>
            <option value="error">Error</option>
          </select>
        </label>
        <button id="log-clear" type="button">Очистить</button>
        <button id="log-export" type="button">Экспорт</button>
        <span id="log-count" class="muted"></span>
      </div>
      <pre id="log-output" class="section" style="max-height:420px;overflow:auto;margin:0;white-space:pre-wrap;"></pre>
    </section>
    <section id="view-settings" class="view">
      <h2>Настройки</h2>
      <div class="section">
        <label>Сеть:
          <select id="network-select">
            <option value="56">BSC</option>
            <option value="97">BSC Testnet</option>
            <option value="1">Ethereum</option>
            <option value="11155111">Sepolia</option>
          </select>
        </label>
        <label>RPC URL: <input id="rpc-url" type="text" /></label>
  <label>API Key (Etherscan V2): <input id="api-key" type="text" /></label>
  <label style="display:block;margin-top:6px;"><input type="checkbox" id="enable-risky-modes" /> Разрешить сид / приватный ключ (я понимаю риски)</label>
  <button type="button" id="save-settings">Сохранить</button>
  <button type="button" id="clear-storage">Очистить локальные данные</button>
        <div id="settings-status" class="muted" style="margin-top:8px;" role="status" aria-live="polite"></div>
      </div>
    </section>
    <section id="view-batch" class="view">
      <h2>Batch Transfers</h2>
      <div class="section" id="batch-panel">
        <div class="row">
          <textarea id="batch-addresses" placeholder="Список адресов (по одному в строке)" style="width:100%;min-height:120px;"></textarea>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="batch-amount" type="number" step="0.0001" min="0" placeholder="Количество" style="width:140px;" />
          <input id="batch-delay" type="number" min="0" value="2500" style="width:120px;" title="Задержка мс" />
          <input id="batch-retries" type="number" min="0" value="2" style="width:100px;" title="Повторы" />
          <input id="batch-concurrency" type="number" min="1" value="1" style="width:100px;" title="Параллельно" />
          <button id="batch-init" type="button">Init</button>
          <button id="batch-start" type="button" disabled>Start</button>
          <button id="batch-pause" type="button" disabled>Pause</button>
          <button id="batch-resume" type="button" disabled>Resume</button>
          <button id="batch-cancel" type="button" disabled>Cancel</button>
          <button id="batch-export" type="button" disabled>Export JSON</button>
        </div>
        <div id="batch-status" class="muted" style="margin-top:6px;"></div>
        <table id="batch-table" style="width:100%;margin-top:10px;font-size:13px;border-collapse:collapse;">
          <thead><tr><th>#</th><th>Адрес</th><th>Статус</th><th>Tx</th><th>Attempts</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <section id="usage-guide" class="section">
      <h2>Как это работает</h2>
      <ol>
        <li>Подключите кошелёк (или альтернативно).</li>
        <li>Заполните 4 поля и нажмите «Создать токен».</li>
        <li>Скопируйте адрес — токен готов.</li>
        <li>Во вкладке «Токен» отправляйте или управляйте allowance.</li>
        <li>Верификация: авто (если включено) или кнопка. По сети подберётся нужный встроенный/ваш ключ.</li>
      </ol>
      <p class="muted">Фиксированный выпуск. Встроенные ключи можно заменить своими при необходимости.<br>Локально. Секреты не сохраняются.</p>
    </section>
  </main>
  <footer>
    <span>© 2025 Печать монет. Все права защищены.</span>
  </footer>
  <script defer src="./js/utils.js"></script>
  <script defer src="./js/projects.js"></script>
  <script defer src="./js/passport.js"></script>
  <script defer src="./js/batch_export.js"></script>
  <script defer src="./js/toast.js"></script>
  <script defer src="./js/batch.js"></script>
  <script defer src="./js/app.js"></script>
  <script defer src="./js/verifier.js"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', ()=>{
      const sel = document.getElementById('network-select');
      if(sel){ sel.value = String(APP_STATE.settings.networkId||56); sel.addEventListener('change', ()=>{ APP_STATE.settings.networkId = parseInt(sel.value,10); saveSettings(); }); }
    });
  </script>
  <script defer>
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('./sw.js').then(reg=>{
          reg.addEventListener('updatefound', ()=>{
            const nw = reg.installing; if(!nw) return;
            nw.addEventListener('statechange', ()=>{
              if(nw.state==='installed' && navigator.serviceWorker.controller){
                if(confirm('Доступна новая версия. Обновить сейчас?')){
                  reg.waiting && reg.waiting.postMessage('skipWaiting');
                  setTimeout(()=>location.reload(),500);
                }
              }
            });
          });
        }).catch(e=>console.error('SW register fail', e));
      });
    }
  </script>
</body>
</html>
